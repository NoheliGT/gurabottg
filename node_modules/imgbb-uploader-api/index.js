const axios = require('axios');
const FormData = require('form-data');
const fs = require('fs');
const path = require('path');

async function uploadImage(imageInput, apiKey, expiration = null) {
  if (!apiKey) {
    throw new Error('API key is required');
  }

  if (!imageInput) {
    throw new Error('Image input is required');
  }

  try {
    const form = new FormData();

    if (imageInput.startsWith('http://') || imageInput.startsWith('https://')) {
      form.append('image', imageInput);
    } else if (fs.existsSync(imageInput)) {
      const file = fs.readFileSync(path.resolve(imageInput));
      form.append('image', file.toString('base64'));
    } else {
      form.append('image', imageInput);
    }

    const expirationQuery = expiration ? `&expiration=${expiration}` : '';
    const response = await axios.post(`https://api.imgbb.com/1/upload?key=${apiKey}${expirationQuery}`, form, {
      headers: form.getHeaders(),
    });

    return response.data;
  } catch (error) {
    console.error('Error uploading image:', error);
    throw error;
  }
}

module.exports = {
  uploadImage,
};
